<!doctype html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="sai-experiment.js"></script>
    <script>
    $(function() {
        var audioCtx = new AudioContext();
        var instrument = {
            oscillators: [
                {
                    type: "sine",
                    gain: 1,
                },
                {
                    type: "sawtooth",
                    gain: 0,
                },
            ],
            attack: 0.1,
            sustain: 0.1,
            release: 0.3,
            gain: 1,
        };
        var t = new sai.Track(audioCtx, instrument);
        t.output.connect(audioCtx.destination);
        var play = function() {
            var song = [];
            var x = 0;
            for (var i = 0; i < 1000; i ++) {
                song.push([x, 69]);
                x += 1;
                song.push([x, 71]);
                x += 1;
                song.push([x, 73]);
                x += 1;
                song.push([x, 69]);
                x += 1;
            };
            var rb = new Date().getTime() / 1000;
            var ab = audioCtx.currentTime;
            var current = 0;
            var handleNote = function() {
                if (current >= song.length)
                    return;
                var noteTime = ab + song[current][0];
                t.playNote(song[current][1], noteTime);
                console.log("scheduling note", song[current][1]);
                current += 1;
                var rt = new Date().getTime() / 1000;
                var noteRealTime = (noteTime - ab) + rb;
                setTimeout(handleNote, (noteRealTime - rt) * 1000);
            };
            handleNote();
        };
        $("button.btna").click(play);
    });
    </script>
</head>
<body>
    <p><button class="btna">Play</button></p>
</body>

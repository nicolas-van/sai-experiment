<!doctype html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="sai-experiment.js"></script>
    <script>
    $(function() {
        var audioCtx = new AudioContext();
        var instrument = {
            oscillators: [
                {
                    type: "sine",
                    gain: 1,
                    freqOsc: {
                        type: "sine",
                        amount: 0,
                        frequency: 10,
                    },
                },
            ],
            filters: [
                {
                    type: "highpass",
                    frequency: 0,
                    gain: 0,
                    q: 1000,
                },
            ],
            attack: 0.05,
            decay: 0.05,
            sustainLevel: 0.5,
            sustainTime: 0.2,
            release: 0.1,
            gain: 0.2,

            noise: 0,
            delay: 0,
            delayTime: 0.3,
            panAmount: 0,
            panFrequency: 2,
        };
        var t = new sai.Track(audioCtx, instrument);
        t.output.connect(audioCtx.destination);
        
        console.log("trying to get midi access");
        window.navigator.requestMIDIAccess().then(function(midiAccess) {
            console.log("midi access granted");
            var inputs = midiAccess.inputs.values();
            for (var input = inputs.next(); input && ! input.done; input = inputs.next()) {
                input.value.onmidimessage = receiveMessage;
            }
        });
        
        var notes = {};
        
        var receiveMessage = function(message) {
            console.log(message);
            var data = message.data;
            var info = {
                cmd: data[0] >> 4,
                channel: data[0] & 0xf,
                type: data[0] & 0xf0,
                note: data[1],
                velocity: data[2],
            };
            
            if (info.type === 144) {
                if (notes[info.note]) {
                    info.note.end();
                }
                notes[info.note] = t.playNote(info.note, null, false);
            } else if (info.type === 128) {
                if (notes[info.note]) {
                    notes[info.note].end();
                    notes[info.note] = undefined;
                }
            }
        };
        
        var x = `hello`;
    });
    </script>
</head>
<body>
    Play with a midi keyboard !
</body>
